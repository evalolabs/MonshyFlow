_format_version: "3.0"
_transform: true

# ============================================
# Services - Backend Services
# ============================================

services:
  # API Service (Workflow Management)
  - name: api-service
    url: http://api-service:80
    routes:
      - name: api-workflows
        paths:
          - /api/workflows
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: api-admin
        paths:
          - /api/admin
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: api-health
        paths:
          - /health
        methods:
          - GET
        strip_path: false
      - name: api-webhooks
        paths:
          - /api/webhooks
        methods:
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: api-internal
        paths:
          - /api/internal
        methods:
          - GET
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: api-tenants
        paths:
          - /api/tenants
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: api-audit-logs
        paths:
          - /api/audit-logs
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: api-support-consents
        paths:
          - /api/support-consents
        methods:
          - GET
          - POST
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false

  # Auth Service
  - name: auth-service
    url: http://auth-service:80
    routes:
      # Öffentliche Auth Routes (keine Auth erforderlich)
      - name: auth-login
        paths:
          - /api/auth/login
        methods:
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: auth-register
        paths:
          - /api/auth/register
        methods:
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      # Token Validation (öffentlich, validiert selbst)
      - name: auth-validate
        paths:
          - /api/auth/validate
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      # User Info (benötigt JWT)
      - name: auth-me
        paths:
          - /api/auth/me
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      # Geschützte Auth Routes (benötigen JWT)
      - name: auth-protected
        paths:
          - /api/auth
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false
      # API Keys Routes
      - name: auth-apikeys
        paths:
          - /api/apikeys
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false

  # Secrets Service
  - name: secrets-service
    url: http://secrets-service:80
    routes:
      - name: secrets-routes
        paths:
          - /api/secrets
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false

  # Execution Service
  - name: execution-service
    url: http://execution-service:5004
    routes:
      # NOTE: /api/execute routes are now handled by API-Service
      # This route is kept for backward compatibility and internal service calls
      - name: execution-execute-internal
        paths:
          - /api/execute
        methods:
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-history
        paths:
          - /api/execution
        methods:
          - GET
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-schemas
        paths:
          - /api/schemas
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-events
        paths:
          - /api/events
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-mcp-handlers
        paths:
          - /api/mcp-handlers
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-web-search-handlers
        paths:
          - /api/web-search-handlers
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-functions
        paths:
          - /api/functions
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-node-processors
        paths:
          - /api/node-processors
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-tool-creators
        paths:
          - /api/tool-creators
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-openai-files-upload
        paths:
          - /api/openai/files/upload
        methods:
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-openai-files-info
        paths:
          - /api/openai/files/info
        methods:
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-openai-files-delete
        paths:
          - /api/openai/files/
        methods:
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-openai-vector-stores-create
        paths:
          - /api/openai/vector-stores/create
        methods:
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-openai-vector-stores-files
        paths:
          - /api/openai/vector-stores/
        methods:
          - POST
          - OPTIONS  # CORS Preflight
        strip_path: false
      - name: execution-openai-vector-stores-remove-file
        paths:
          - /api/openai/vector-stores/
        methods:
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false
        # This route handles /api/openai/vector-stores/:vectorStoreId/files/:fileId
        # Must come before the generic delete route to match first
      - name: execution-openai-vector-stores-files-list
        paths:
          - /api/openai/vector-stores/
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
        # This route handles /api/openai/vector-stores/:vectorStoreId/files
        # Must come before the generic get route to match first
      - name: execution-openai-vector-stores-get
        paths:
          - /api/openai/vector-stores/
        methods:
          - GET
          - OPTIONS  # CORS Preflight
        strip_path: false
        # This route handles /api/openai/vector-stores/:vectorStoreId (without /files)
      - name: execution-openai-vector-stores-delete
        paths:
          - /api/openai/vector-stores/
        methods:
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false

  # Scheduler Service
  - name: scheduler-service
    url: http://scheduler-service:80
    routes:
      - name: scheduler-routes
        paths:
          - /api/scheduler
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS  # CORS Preflight
        strip_path: false

# ============================================
# Plugins - Global & Service-spezifisch
# ============================================

plugins:
  # CORS Plugin (global)
  - name: cors
    config:
      origins:
        - "*"  # In Development: alle Origins erlauben
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Request-ID
      exposed_headers:
        - X-Request-ID
      credentials: true
      max_age: 3600
      preflight_continue: false  # Kong behandelt OPTIONS automatisch

  # Rate Limiting für öffentliche Auth Routes
  # Erhöht für E2E-Tests und Development
  - name: rate-limiting
    service: auth-service
    route: auth-login
    config:
      minute: 1000  # Erhöht für E2E-Tests (Standard: 10)
      hour: 10000   # Erhöht für E2E-Tests (Standard: 100)
      policy: local
      hide_client_headers: false  # Zeige Rate-Limit-Header (Standard: true)
      limit_by: ip  # Limit pro IP-Adresse
  - name: rate-limiting
    service: auth-service
    route: auth-register
    config:
      minute: 1000  # Erhöht für E2E-Tests (Standard: 10)
      hour: 10000   # Erhöht für E2E-Tests (Standard: 100)
      policy: local
      hide_client_headers: false
      limit_by: ip

  # Rate Limiting für API Routes
  - name: rate-limiting
    service: api-service
    config:
      minute: 1000
      hour: 10000
      policy: local

  # Rate Limiting für Secrets Service
  # Sehr hoch für E2E-Tests und Development
  - name: rate-limiting
    service: secrets-service
    route: secrets-routes
    config:
      minute: 5000  # Sehr hoch für E2E-Tests (erhöht von 2000)
      hour: 50000   # Sehr hoch für E2E-Tests (erhöht von 20000)
      policy: local
      hide_client_headers: false
      limit_by: ip

  # Request ID Plugin (für Tracing)
  - name: correlation-id
    config:
      header_name: X-Request-ID
      echo_downstream: true
      generator: uuid

  # Request/Response Logging
  - name: file-log
    config:
      path: /dev/stdout
      reopen: true


