name: Check Breaking Changes

on:
  pull_request:
    paths:
      - 'frontend/src/**'
      - 'packages/execution-service/src/nodes/**'
      - 'shared/registry.json'
      - '.github/PULL_REQUEST_TEMPLATE.md'

# Security: Restrict permissions to minimum required
permissions:
  contents: read  # Only read repository contents
  pull-requests: read  # Only read PR information
  # No write permissions - cannot modify repository

jobs:
  validate-breaking-changes:
    runs-on: ubuntu-latest
    # Security: Workflow runs on all PRs
    # CODEOWNERS ensures workflow file changes require @evalolabs review
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comparison
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install --frozen-lockfile
      
      - name: Run Backward Compatibility Tests
        run: |
          cd frontend
          pnpm test backward-compatibility
      
      - name: Check PR Description for Breaking Changes
        if: github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Write PR body to temporary file to avoid shell interpretation issues
          echo "$PR_BODY" > /tmp/pr_body.txt
          
          # Check if breaking change is marked
          if grep -q "üí• Breaking change" /tmp/pr_body.txt; then
            echo "‚ö†Ô∏è Breaking change detected in PR"
            
            # Check if migration path is provided
            if ! grep -q "Migration Path" /tmp/pr_body.txt; then
              echo "‚ùå ERROR: Breaking change PR must include 'Migration Path' section"
              echo "Please add a Migration Path section to your PR description"
              exit 1
            fi
            
            # Check if affected areas are listed
            if ! grep -q "Affected Areas" /tmp/pr_body.txt; then
              echo "‚ö†Ô∏è WARNING: Breaking change PR should list 'Affected Areas'"
            fi
            
            echo "‚úÖ Breaking change PR has required information"
          else
            echo "‚úÖ No breaking changes detected"
          fi
          
          # Cleanup
          rm -f /tmp/pr_body.txt

